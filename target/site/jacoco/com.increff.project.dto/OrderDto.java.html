<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrderDto.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">project</a> &gt; <a href="index.source.html" class="el_package">com.increff.project.dto</a> &gt; <span class="el_source">OrderDto.java</span></div><h1>OrderDto.java</h1><pre class="source lang-java linenums">package com.increff.project.dto;

import com.increff.project.model.OrderData;
import com.increff.project.model.OrderForm;
import com.increff.project.pojo.InventoryPojo;
import com.increff.project.pojo.OrderItemPojo;
import com.increff.project.pojo.OrderPojo;
import com.increff.project.pojo.ProductPojo;
import com.increff.project.service.ApiException;
import com.increff.project.service.InventoryService;
import com.increff.project.service.OrderItemService;
import com.increff.project.service.OrderService;
import com.increff.project.service.ProductService;


import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import javax.transaction.Transactional;

import java.io.*;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.*;

@Service
<span class="nc" id="L27">public class OrderDto {</span>
    @Autowired
    private OrderService orderService;

    @Autowired
    private OrderItemService orderItemService;

    @Autowired
    private ProductService productService;

    @Autowired
    private InventoryService inventoryService;

   
    protected static OrderData addProductToOrderData(ProductPojo productPojo) {
<span class="nc" id="L42">        OrderData orderData = new OrderData();</span>
<span class="nc" id="L43">        orderData.setMrp(productPojo.getMrp());</span>
<span class="nc" id="L44">        orderData.setBarcode(productPojo.getBarcode());</span>
<span class="nc" id="L45">        orderData.setProductName(productPojo.getName());</span>
<span class="nc" id="L46">        Date dateobj = new Date();</span>
<span class="nc" id="L47">        orderData.setDate(dateobj);</span>
<span class="nc" id="L48">        return orderData;</span>
    }

   /* protected static String getDate() {
    	DateFormat df=new SimpleDateFormat(&quot;dd-MM-yyyy HH:mm&quot;);
        Date dateobj = new Date();
        String datetime=df.format(dateobj);
        return datetime;
    }*/
    @Transactional(rollbackOn = ApiException.class)
    public void add(List&lt;OrderForm&gt; orderForms) throws ApiException {

<span class="nc" id="L60">    	Date dateobj = new Date();</span>
       // orderForms = checkForDuplicates(orderForms);
<span class="nc" id="L62">        List&lt;OrderItemPojo&gt; orderItemPojos = convertToOrderitems(orderForms);// no errros</span>

<span class="nc" id="L64">        OrderPojo orderPojo = new OrderPojo();</span>
<span class="nc" id="L65">        orderPojo.setDate(dateobj);</span>
<span class="nc" id="L66">        orderService.add(orderPojo);</span>
        
<span class="nc" id="L68">        int orderId = orderPojo.getId();</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">        if (orderId &lt;= 0)</span>
<span class="nc" id="L70">            throw new ApiException(&quot;Order with id :&quot; + orderId + &quot; doestn't exist&quot;);</span>

<span class="nc bnc" id="L72" title="All 2 branches missed.">        for (OrderItemPojo orderItemPojo : orderItemPojos) {</span>
<span class="nc" id="L73">            orderItemPojo.setOrderId(orderId);</span>
            //orderItemPojo.setSellingPrice();
<span class="nc" id="L75">            orderItemService.add(orderItemPojo); // first check the conditions and then make the order</span>
<span class="nc" id="L76">        }</span>
        
<span class="nc" id="L78">    }</span>

   
    protected List&lt;OrderItemPojo&gt; convertToOrderitems(List&lt;OrderForm&gt; orderForms) throws ApiException {
<span class="nc" id="L82">        List&lt;OrderItemPojo&gt; orderItemPojos = new ArrayList&lt;OrderItemPojo&gt;();</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        for (OrderForm orderForm : orderForms) {</span>
<span class="nc" id="L84">            orderItemPojos.add(convertToOrderitem(orderForm));</span>
<span class="nc" id="L85">        }</span>
<span class="nc" id="L86">        return orderItemPojos;</span>
    }

    protected OrderItemPojo convertToOrderitem(OrderForm orderForm) throws ApiException {
        //orderId is not set
<span class="nc" id="L91">        OrderItemPojo orderItemPojo = new OrderItemPojo();</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (orderForm.getQuantity() &lt; 0)</span>
<span class="nc" id="L93">            orderForm.setQuantity(0);</span>
<span class="nc" id="L94">        orderItemPojo.setQuantity(orderForm.getQuantity());</span>

<span class="nc" id="L96">        ProductPojo productPojo = productService.get(orderForm.getBarcode());</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (productPojo == null)</span>
<span class="nc" id="L98">            throw new ApiException(&quot;Product doesn't exist ,barcode :&quot; + orderForm.getBarcode());</span>
<span class="nc" id="L99">        orderItemPojo.setProductId(productPojo.getId());</span>
<span class="nc" id="L100">        orderItemPojo.setSellingPrice(productPojo.getMrp() * orderForm.getQuantity()); // changed to mrp*qty</span>

<span class="nc" id="L102">        InventoryPojo inventoryPojo = inventoryService.getByProductId(productPojo.getId());</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (inventoryPojo.getQuantity() &lt; orderForm.getQuantity())</span>
<span class="nc" id="L104">            throw new ApiException(&quot;Out Of Stock ! Available : &quot; + inventoryPojo.getQuantity() + &quot; but wanted : &quot; + orderForm.getQuantity());</span>
        // no errors then order is made

<span class="nc" id="L107">        inventoryPojo.setQuantity(inventoryPojo.getQuantity() - orderForm.getQuantity());</span>
<span class="nc" id="L108">        inventoryService.update(productPojo.getId(), inventoryPojo);</span>

<span class="nc" id="L110">        return orderItemPojo;</span>
    }

    public OrderData get(String barcode) throws ApiException {
<span class="nc" id="L114">        return convert(barcode);//orderItemPOjo to orderdata</span>
    }

    protected OrderData convert(String barcode) throws ApiException {
<span class="nc" id="L118">        ProductPojo productPojo = productService.get(barcode);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (productPojo == null)</span>
<span class="nc" id="L120">            throw new ApiException(&quot;Product doesn't exist ,barcode :&quot; + barcode);</span>
<span class="nc" id="L121">        InventoryPojo inventoryPojo = inventoryService.getByProductId(productPojo.getId());</span>

<span class="nc" id="L123">        OrderData orderData = addProductToOrderData(productPojo);</span>
<span class="nc" id="L124">        orderData.setQuantity(inventoryPojo.getQuantity());</span>
<span class="nc" id="L125">        return orderData;</span>
    }

    @Transactional
    public List&lt;OrderData&gt; getAll() throws ApiException {
<span class="nc" id="L130">        List&lt;OrderPojo&gt; orderPojos = orderService.getAll();</span>

<span class="nc" id="L132">        List&lt;OrderData&gt; orderDatas = new ArrayList&lt;OrderData&gt;();</span>

<span class="nc bnc" id="L134" title="All 2 branches missed.">        for (OrderPojo orderPojo : orderPojos) {</span>
<span class="nc" id="L135">            List&lt;OrderItemPojo&gt; orderItemPojos = orderItemService.getByOrderId(orderPojo.getId());</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">            for (OrderItemPojo orderItemPojo : orderItemPojos) {</span>
<span class="nc" id="L137">                ProductPojo productPojo = productService.get(orderItemPojo.getProductId());</span>
<span class="nc" id="L138">                OrderData orderData = addProductToOrderData(productPojo);</span>
<span class="nc" id="L139">                orderData.setOrderId(orderPojo.getId());</span>
<span class="nc" id="L140">                orderData.setQuantity(orderItemPojo.getQuantity());</span>
<span class="nc" id="L141">                orderDatas.add(orderData);    // add orderId vise</span>
<span class="nc" id="L142">            }</span>
<span class="nc" id="L143">        }</span>
<span class="nc" id="L144">        return orderDatas;</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>